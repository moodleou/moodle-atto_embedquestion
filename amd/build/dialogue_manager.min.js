/**
 * Manages the question selection form.
 *
 * @module    atto_embedquestion/dialogue_manager
 * @copyright 2018 The Open University
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("atto_embedquestion/dialogue_manager",["jquery","core/notification","core/fragment","core/templates","core/ajax"],(function($,Notification,Fragment,Templates,Ajax){function DialogueHandler(button){var currentSelection,dialogue,existingCode;function dialogueResized(){dialogue.centerDialogue()}function getEmbedCode(e){e.preventDefault();var iframedescription=$("input#id_iframedescription").val(),questionidnumber=$("select#id_questionidnumber").val();questionidnumber&&(iframedescription.length&&(iframedescription.length<3||iframedescription.length>100)||Ajax.call([{methodname:"filter_embedquestion_get_embed_code",args:{courseid:$("input[name=courseid]").val(),categoryidnumber:$("select#id_categoryidnumber").val(),questionidnumber:questionidnumber,iframedescription:iframedescription,behaviour:$("select#id_behaviour").val(),maxmark:$("input#id_maxmark").val(),variant:$("input#id_variant").val(),correctness:$("select#id_correctness").val(),marks:$("select#id_marks").val(),markdp:$("select#id_markdp").val(),feedback:$("select#id_feedback").val(),generalfeedback:$("select#id_generalfeedback").val(),rightanswer:$("select#id_rightanswer").val(),history:$("select#id_history").val(),forcedlanguage:$("select#id_forcedlanguage").val()||""}}])[0].done(insertEmbedCode))}function insertEmbedCode(embedCode){var host,parent,text,existingCode;button.getDialogue({focusAfterHide:null}).hide(),(host=button.get("host")).setSelection(currentSelection),(existingCode=button.getEmbedCodeAtSelection())?(text=(parent=host.getSelectionParentNode()).textContent,parent.textContent=text.slice(0,existingCode.start)+embedCode+text.slice(existingCode.end)):host.insertContentAtFocusPoint(embedCode),button.markUpdated()}currentSelection=button.get("host").getSelection(),(dialogue=button.getDialogue({headerContent:M.util.get_string("pluginname","atto_embedquestion"),focusAfterHide:!0},!0)).set("bodyContent",'<div class="atto_embedquestion-wrap"><img class="icon" src="'+M.util.image_url("y/loading")+'" alt="'+M.util.get_string("loading","atto_embedquestion")+'"></div>'),dialogue.show(),(existingCode=button.getEmbedCodeAtSelection())&&(existingCode=existingCode.embedCode),Fragment.loadFragment("atto_embedquestion","questionselector",button.get("contextid"),{contextId:button.get("contextid"),embedCode:existingCode}).done((function(html,js){!function(node,html,js){var promise=$.Deferred();node.fadeOut("fast",(function(){Templates.replaceNodeContents(node,html,js),node.fadeIn("fast",(function(){promise.resolve(),$("#embedqform #id_submitbutton").on("click",getEmbedCode),function(){dialogue.centerDialogue();var observer=new MutationObserver(dialogueResized);$("#embedqform fieldset.collapsible").each((function(index,node){observer.observe(node,{attributes:!0,attributeFilter:["class"]})}))}()}))})),promise.promise()}($(".atto_embedquestion-wrap"),html,js)})).fail(Notification.exception)}return{showDialogueFor:function(button){new DialogueHandler(button)}}}));

//# sourceMappingURL=dialogue_manager.min.js.map